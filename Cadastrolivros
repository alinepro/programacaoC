#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_LIVROS 50
#define TAM_STRING 100
#define MAX_EMPRESTIMOS 100

struct Livro{
  char nome [TAM_STRING];
  char autor [TAM_STRING];
  char editora [TAM_STRING];
  int edicao;
  int disponivel;
};

struct Emprestimo{
  int indiceLivro;
  char nomeUsuario[TAM_STRING];
};

//protótipo das funções
// declarar funções aqui permite que a main as chame antes de suas definições

void limparBufferEntrada (){
  int c;
  while ((c = getchar()) != '\n' && c != EOF);

int main ();
   
    struct Livro*biblioteca;
    struct Emprestimo*emprestimos;

biblioteca=(struct Livro*)calloc(MAX_LIVROS, sizeof(struct Livro));
emprestimos = (struct Emprestimo*) malloc(MAX_EMPRESTIMOS*ssizeof(struct Emprestimo));

if(biblioteca == nuLL|| emprestimos == nuLL){
  printf("ERRO: Falha ao alocar memória!\n');
return 1;
}
    int totalLivros = 0;
    int totalEmprestimos = 0;
    int opcao;
do{
printf("===========================\n");
printf("   Biblioteca - Parte 2\n");
printf("===========================\n");
printf("1 - Cadastrar novo livro\n");
printf("2 - Listar todos os livros\n");
printf("3 - Realizar empréstimos\n");
printf("4 - Listar empréstimos\n");
printf("0 - Sair\n");
printf("-----------------------------------\n");
printf("Escolha uma opção: ");

scanf("%d", &opcao);
limparBufferEntrada();

switch (opcao) {
  case 1:
    printf("--- Cadastro de Novo Livro ---\n\n");
          
        if (totalLivros < MAX_LIVROS) {
            printf("Digite o nome do livro: \n");
            fgets(biblioteca[totalLivros].nome, TAM_STRING, stdin);

            printf("Digite o autor: \n");
            fgets(biblioteca[totalLivros].autor, TAM_STRING, stdin);

            printf("Digite a editora: \n");
            fgets(biblioteca[totalLivros].editora, TAM_STRING, stdin);

          biblioteca[totalLivros].nome[strcspn(biblioteca[totalLivros].nome,  "\n")] =
          biblioteca[totalLivros].autor[strcspn(biblioteca[totalLivros].autor,  "\n")] =
          biblioteca[totalLivros].editora[strcspn(biblioteca[totalLivros].editora,  "\n")] =

            printf("Digite a edição: ");
            scanf("%d", &biblioteca[totalLivros].edicao);
            limparBufferEntraada();

          totalLivros++;

          printf("\n Livro cadastrado com sucesso!\n");
      } else {
          printf("Biblioteca cheia! Não é possivel cadastrar mais livros.\n");
      }
  case 2: 
    printf(" Lista de livros cadastrados\n");
    int totalLivros;
    if (totalLivros ==0){
      printf("Nenhum livro cadastrado \n");
    }else{
      for(int i=0; i<totalLivros; i++){
        printf("LIVRO %d\n",i+1);
        printf("Nome: %s\n",biblioteca[i].nome);
        printf("Autor: %s\n",biblioteca[i].autor);
        printf("Editora: %s\n",biblioteca[i].editora);
        printf("Edição: %d\n",biblioteca[i].edicao);
      }
      printf("------------------------------------\n");
      printf("Pressione ENTER para continuar\n");      
      getchar();
      break;
    }
  case 3:
    printf("   Realizar Emprestimos   \n");
  
  if(totalEmprestimos >= MAX_EMPRESTIMOS){
    printf("Limite atingido\n");
  } else{
    printf("Livros disponíveis\n");

    int disponiveis = 0;
    for (int i=0; i<totalLivros; i++){
        if(biblioteca[i].disponiveis){
          printf("%d - %s\n", i + 1, biblioteca[i].nome);
          disponiveis ++;
        }
    }
    if(disponiveis ==0){
      printf(" Nenhum livro disponível\n);
    } else{
      printf("\n Digite o número do Livro que deseja emprestar: ");
      int numLivro;
      scanf("%d", &numLivro);
    limparBufferEntrada();

    int indice = numLivro-1;

    if(indice >= 0 && indice < totalLivros && biblioteca[indice].disponiveis){
      printf("Digite o nome do usuário que está pegando o Livro:  ");
      fgets (emprestimos[totalEmprestimos].nomeUsuario, TAM_STRING, stdin);
      emprestimos[totalEmprestimos].nomeUsuario[strcspn(emprestimos[totalEmprestimos])];
      emprestimos[totalEmprestimos].indiceLivro = indice;
      biblioteca[indice].disponiveis = 0;
      totalEmprestimos ++;
      printf("\n Emprestimo realizado com sucesso\n");
    }else{
      printf("\n Numero do livro inválido ou livro indisponivel\n");
      }
      printf("\n Pressione ENTER para continuar...");
  getchar();
  break;

  case 4:
    printf ("---Lista de emprestimos---\n\n");
    if(totalEmprestimos ==0){
      printf(" Nenhum emprestimo realizado\n");
    } else{
      for(int i=0; i <totalEmprestimos; i++){
          int indiceLivro = emprestimos[i].indiceLivro;
          printf(" -----------------------------\n");
          printf("EMPRESTIMO: %d\n",i+1);
          printf("LIVRO: %s\n",biblioteca[indiceLivro].nome);
          printf("USUÁRIO: %s\n", emprestimos[i].nomeUsuario);
      }
      printf(" -----------------------------\n");
    }

  case 0:
    printf("Saindo do sistema\n");
    break;

  default: 
    printf("OPÇÃO INVÁLIDA!\n");
    printf("Pressione ENTER para continuar\n");
    break;
  }
} while(opcao !=0);
free (biblioteca);
free(emprestimos);
printf("Memória liberada com sucesso!\n");
return 0;
}
